import { readFileSync, writeFileSync } from 'node:fs';
import { dirname, join, resolve } from 'node:path';
import glob from 'tiny-glob';
import type { PluginOption } from 'vite';

import colorLog from '../log';

const __dirname = dirname(new URL(import.meta.url).pathname);
const buildDir = resolve(__dirname, '..', '..', 'build');

const hash = (value: string) => {
  let hash = 5381;
  let i = value.length;

  while (i) {
    hash = (hash * 33) ^ value.charCodeAt(--i);
  }

  return (hash >>> 0).toString(36);
};

const transformContent = (content: string) => {
  return content
    .replace('__sveltekit', 'const __sveltekit')
    .replace('document.currentScript.parentElement', 'document.body.firstElementChild');
};

/**
 * Extract the inline script.
 *
 * @param to File path to extract
 * @param scriptRegex Script regex to extract
 * @param getFilename Function to return the extracted script filename
 * @param getScriptTag Function to return the extracted script tag
 */
const extractScript = async (
  to: string,
  scriptRegex: RegExp,
  getFilename: (hash: string) => string,
  getScriptTag: (filename: string) => string
) => {
  const files = await glob('**/*.{html}', {
    cwd: to,
    dot: true,
    absolute: false,
    filesOnly: true
  });

  for (const file of files.map((file) => join(to, file))) {
    colorLog(`edit file: ${file}`, 'info', true);

    const f = readFileSync(file, { encoding: 'utf-8' });
    const scriptMatch = f.match(scriptRegex);

    if (scriptMatch) {
      let inlineContent = scriptMatch[1];
      inlineContent = transformContent(inlineContent);
      const scriptHash = hash(inlineContent);
      const scriptFilename = getFilename(scriptHash);
      const scriptTag = getScriptTag(scriptFilename);
      const newHtml = f.replace(scriptRegex, scriptTag);

      writeFileSync(file, newHtml);
      writeFileSync(`${to}${scriptFilename}`, inlineContent);

      colorLog(`âœ… Script extracted and saved at: ${to}${scriptFilename}`, 'success', true);
    }
  }
};

/**
 * In Manifest V3, inline scripts are not allowed by the content security policy.
 *
 * Extract the inline script in the `*.html` file of the file generated by the `@sveltejs/adapter-static` adapter to a file named
 * `*.{hash}.js' file and paste the extracted script into the `*.html' file.
 */
const extractInlineScript = (): PluginOption => {
  return {
    name: 'extract-inline-script',
    closeBundle() {
      extractScript(
        buildDir,
        /<script nonce="%sveltekit.nonce%">([\s\S]*?)<\/script>/,
        (hash) => `/color-scheme-script.${hash}.js`,
        (filename) => `<script nonce="%sveltekit.nonce%" src='${filename}'></script>`
      );
      extractScript(
        buildDir,
        /<script>([\s\S]+)<\/script>/,
        (hash) => `/script-${hash}.js`,
        (filename) => `<script type="module" src="${filename}"></script>`
      );
    }
  };
};

export default extractInlineScript;
